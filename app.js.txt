let currentUser = null;
let currentBranch = null;
let currentSemester = null;

function showPage(pageName) {
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });
    document.getElementById(pageName).classList.add('active');
}

function showDashboard(section) {
    document.querySelectorAll('.dashboard-section').forEach(sec => {
        sec.classList.remove('active');
    });
    document.getElementById(section).classList.add('active');
    
    if (section === 'allBranches') {
        loadBranches();
    } else if (section === 'myUploads') {
        loadMyUploads();
    } else if (section === 'overview') {
        loadDashboard();
    }
}

async function handleSignup(event) {
    event.preventDefault();
    const form = event.target;
    const email = form[0].value;
    const password = form[1].value;
    const confirmPassword = form[2].value;
    
    if (password !== confirmPassword) {
        alert('Passwords do not match!');
        return;
    }
    
    const { data, error } = await supabase.auth.signUp({
        email: email,
        password: password
    });
    
    if (error) {
        alert('Signup error: ' + error.message);
    } else {
        alert('Account created! Check your email for verification!');
        showPage('signIn');
    }
}

async function handleLogin(event) {
    event.preventDefault();
    const form = event.target;
    const email = form[0].value;
    const password = form[1].value;
    
    const { data, error } = await supabase.auth.signInWithPassword({
        email: email,
        password: password
    });
    
    if (error) {
        alert('Login error: ' + error.message);
    } else {
        currentUser = data.user;
        showPage('dashboard');
        loadDashboard();
    }
}

function logout() {
    supabase.auth.signOut();
    currentUser = null;
    showPage('landingPage');
}

function showCreateBranch() {
    document.querySelectorAll('.dashboard-section').forEach(sec => {
        sec.classList.remove('active');
    });
    document.getElementById('createBranchForm').style.display = 'block';
}

async function handleCreateBranch(event) {
    event.preventDefault();
    const form = event.target;
    const name = form[0].value;
    const description = form[1].value;
    
    const { data, error } = await supabase
        .from('branches')
        .insert([
            { 
                name: name, 
                description: description,
                created_by: currentUser.id
            }
        ]);
    
    if (error) {
        alert('Error: ' + error.message);
    } else {
        alert('Branch created!');
        form.reset();
        document.getElementById('createBranchForm').style.display = 'none';
        showDashboard('allBranches');
    }
}

async function loadBranches() {
    const { data, error } = await supabase
        .from('branches')
        .select('*')
        .order('created_at', { ascending: false });
    
    if (error) {
        console.error('Error:', error);
        return;
    }
    
    const branchList = document.getElementById('branchList');
    branchList.innerHTML = '';
    
    if (data.length === 0) {
        branchList.innerHTML = '<p>No branches yet. Create one!</p>';
        return;
    }
    
    data.forEach(branch => {
        const card = document.createElement('div');
        card.className = 'branch-card';
        card.innerHTML = `
            <h3>${branch.name}</h3>
            <p>${branch.description || 'No description'}</p>
            <button onclick="deleteBranch('${branch.id}')" class="btn-delete">üóëÔ∏è Delete</button>
        `;
        card.onclick = (e) => {
            if (!e.target.classList.contains('btn-delete')) {
                openBranch(branch);
            }
        };
        branchList.appendChild(card);
    });
}

async function deleteBranch(branchId) {
    if (!confirm('Delete this branch and all its content?')) return;
    
    const { error } = await supabase
        .from('branches')
        .delete()
        .eq('id', branchId);
    
    if (error) {
        alert('Error: ' + error.message);
    } else {
        alert('Deleted!');
        loadBranches();
    }
}

function openBranch(branch) {
    currentBranch = branch;
    document.getElementById('branchTitle').textContent = branch.name;
    loadSemesters(branch.id);
    showDashboard('branchDetail');
}

function showCreateSemester() {
    document.querySelectorAll('.dashboard-section').forEach(sec => {
        sec.classList.remove('active');
    });
    document.getElementById('createSemesterForm').style.display = 'block';
}

function cancelSemester() {
    document.getElementById('createSemesterForm').style.display = 'none';
    showDashboard('branchDetail');
}

async function handleCreateSemester(event) {
    event.preventDefault();
    const form = event.target;
    const number = form[0].value;
    const name = form[1].value;
    
    const { data, error } = await supabase
        .from('semesters')
        .insert([
            { 
                branch_id: currentBranch.id,
                semester_number: number,
                name: name
            }
        ]);
    
    if (error) {
        alert('Error: ' + error.message);
    } else {
        alert('Semester created!');
        form.reset();
        cancelSemester();
        loadSemesters(currentBranch.id);
    }
}

async function loadSemesters(branchId) {
    const { data, error } = await supabase
        .from('semesters')
        .select('*')
        .eq('branch_id', branchId)
        .order('semester_number', { ascending: true });
    
    if (error) {
        console.error('Error:', error);
        return;
    }
    
    const semesterList = document.getElementById('semesterList');
    semesterList.innerHTML = '';
    
    if (data.length === 0) {
        semesterList.innerHTML = '<p>No semesters yet!</p>';
        return;
    }
    
    data.forEach(semester => {
        const card = document.createElement('div');
        card.className = 'branch-card';
        card.innerHTML = `
            <h3>Semester ${semester.semester_number}: ${semester.name}</h3>
            <button onclick="deleteSemester('${semester.id}')" class="btn-delete">üóëÔ∏è Delete</button>
        `;
        card.onclick = (e) => {
            if (!e.target.classList.contains('btn-delete')) {
                openSemester(semester);
            }
        };
        semesterList.appendChild(card);
    });
}

async function deleteSemester(semesterId) {
    if (!confirm('Delete this semester?')) return;
    
    const { error } = await supabase
        .from('semesters')
        .delete()
        .eq('id', semesterId);
    
    if (error) {
        alert('Error: ' + error.message);
    } else {
        alert('Deleted!');
        loadSemesters(currentBranch.id);
    }
}

function openSemester(semester) {
    currentSemester = semester;
    document.getElementById('semesterTitle').textContent = `Semester ${semester.semester_number}: ${semester.name}`;
    loadSections(semester.id);
    showDashboard('semesterDetail');
}

async function addSection() {
    const input = document.getElementById('newSectionInput');
    const sectionName = input.value.trim();
    
    if (!sectionName) {
        alert('Enter a section name');
        return;
    }
    
    const { data, error } = await supabase
        .from('sections')
        .insert([
            { 
                semester_id: currentSemester.id,
                name: sectionName
            }
        ]);
    
    if (error) {
        alert('Error: ' + error.message);
    } else {
        input.value = '';
        loadSections(currentSemester.id);
    }
}

async function loadSections(semesterId) {
    const { data, error } = await supabase
        .from('sections')
        .select('*')
        .eq('semester_id', semesterId);
    
    if (error) {
        console.error('Error:', error);
        return;
    }
    
    const sectionList = document.getElementById('sectionList');
    sectionList.innerHTML = '';
    
    if (data.length === 0) {
        sectionList.innerHTML = '<p>No sections yet!</p>';
        return;
    }
    
    data.forEach(section => {
        const item = document.createElement('div');
        item.className = 'branch-card';
        item.innerHTML = `
            <h4>${section.name}</h4>
            <button onclick="deleteSection('${section.id}')" class="btn-delete">üóëÔ∏è Delete</button>
        `;
        sectionList.appendChild(item);
    });
}

async function deleteSection(sectionId) {
    if (!confirm('Delete this section?')) return;
    
    const { error } = await supabase
        .from('sections')
        .delete()
        .eq('id', sectionId);
    
    if (error) {
        alert('Error: ' + error.message);
    } else {
        alert('Deleted!');
        loadSections(currentSemester.id);
    }
}

async function searchContent() {
    const query = document.getElementById('searchInput').value;
    
    if (!query) {
        alert('Enter search term');
        return;
    }
    
    const { data, error } = await supabase
        .from('documents')
        .select('*')
        .or(`title.ilike.%${query}%,description.ilike.%${query}%`);
    
    if (error) {
        console.error('Error:', error);
        return;
    }
    
    const results = document.getElementById('searchResults');
    results.innerHTML = '';
    
    if (data.length === 0) {
        results.innerHTML = '<p>No documents found</p>';
        return;
    }
    
    data.forEach(doc => {
        const item = document.createElement('div');
        item.className = 'branch-card';
        item.innerHTML = `
            <h3>${doc.title}</h3>
            <p>${doc.description || 'No description'}</p>
            <button onclick="deleteDocument('${doc.id}')" class="btn-delete">üóëÔ∏è Delete</button>
        `;
        results.appendChild(item);
    });
}

async function deleteDocument(docId) {
    if (!confirm('Delete this document?')) return;
    
    const { error } = await supabase
        .from('documents')
        .delete()
        .eq('id', docId);
    
    if (error) {
        alert('Error: ' + error.message);
    } else {
        alert('Deleted!');
        searchContent();
    }
}

async function loadDashboard() {
    const { data: branches } = await supabase.from('branches').select('id');
    document.getElementById('totalBranches').textContent = branches?.length || 0;
    
    const { data: uploads } = await supabase
        .from('documents')
        .select('id')
        .eq('uploaded_by', currentUser.id);
    document.getElementById('myUploadsCount').textContent = uploads?.length || 0;
    
    const { data: docs } = await supabase.from('documents').select('id');
    document.getElementById('totalDocs').textContent = docs?.length || 0;
}

async function loadMyUploads() {
    const { data, error } = await supabase
        .from('documents')
        .select('*')
        .eq('uploaded_by', currentUser.id);
    
    if (error) {
        console.error('Error:', error);
        return;
    }
    
    const uploadsList = document.getElementById('uploadsList');
    uploadsList.innerHTML = '';
    
    if (data.length === 0) {
        uploadsList.innerHTML = '<p>No uploads yet</p>';
        return;
    }
    
    data.forEach(doc => {
        const item = document.createElement('div');
        item.className = 'branch-card';
        item.innerHTML = `
            <h3>${doc.title}</h3>
            <p>${doc.description || 'No description'}</p>
            <button onclick="deleteDocument('${doc.id}')" class="btn-delete">üóëÔ∏è Delete</button>
        `;
        uploadsList.appendChild(item);
    });
}

supabase.auth.onAuthStateChange((event, session) => {
    if (session) {
        currentUser = session.user;
        showPage('dashboard');
        loadDashboard();
    } else {
        showPage('landingPage');
    }
});
